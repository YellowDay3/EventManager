<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      position: relative;
    }
    
    .logout-btn {
      position: absolute;
      top: 0;
      right: 0;
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 1.35rem;
    }
    
    .header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .header .infothing .username {
      font-weight: 700;
      font-size: 1.5rem;
      opacity: 0.9;
    }
    
    .header .infothing .user-group {
      font-size: 1.3rem;
      opacity: 0.85;
      font-weight: 350;
      padding: 0.4rem 1.5rem;
    }
    
    .card {
      background: white;
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .scanner-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    .video-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      aspect-ratio: 1 / 1;
      margin: 0 auto 2rem;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      border: 4px solid #667eea;
    }
    
    #video {
      width: 100%;
      height: 100%;
      display: block;
      background: #000;
      object-fit: cover;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .scanner-frame {
      position: relative;
      width: 95%;
      height: 95%;
      border: 3px solid rgba(255, 255, 255, 0.8);
      border-radius: 16px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }
    
    .scanner-frame::before,
    .scanner-frame::after,
    .corner-tl,
    .corner-tr {
      content: '';
      position: absolute;
      width: 60px;
      height: 60px;
      border: 5px solid #667eea;
    }
    
    .scanner-frame::before {
      top: -5px;
      left: -5px;
      border-right: none;
      border-bottom: none;
      border-top-left-radius: 16px;
    }
    
    .scanner-frame::after {
      bottom: -5px;
      right: -5px;
      border-left: none;
      border-top: none;
      border-bottom-right-radius: 16px;
    }
    
    .corner-tl {
      top: -5px;
      right: -5px;
      border-left: none;
      border-bottom: none;
      border-top-right-radius: 16px;
    }
    
    .corner-tr {
      bottom: -5px;
      left: -5px;
      border-right: none;
      border-top: none;
      border-bottom-left-radius: 16px;
    }
    
    #canvas {
      display: none;
    }

    .infothing {
      color: #000000;
      text-align: center;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 1.5rem;
      background: #f9fafb;
      border-radius: 12px;
      margin-top: 1rem;
    }
    
    .result-container {
      text-align: center;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 1.5rem;
      background: #f9fafb;
      border-radius: 12px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .result-container.show {
      opacity: 1;
    }
    
    .result-text {
      padding-top: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .result-ready {
      color: #667eea;
    }
    
    .result-scanning {
      color: #f59e0b;
    }
    
    .result-success {
      color: #10b981;
    }
    
    .result-error {
      color: #ef4444;
    }

    /* === NEW BUTTON STYLING === */
    .scan-next-btn {
      margin-top: 1.5rem;
      width: 100%;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .scan-next-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .scan-next-btn:active {
      transform: scale(0.98);
    }
    
    /* Success Checkmark Animation */
    .success-checkmark {
      width: 50px;
      height: 50px;
      margin: 0 auto 0.5rem;
    }
    
    .check-icon {
      width: 50px;
      height: 50px;
      position: relative;
      border-radius: 50%;
      box-sizing: content-box;
      border: 3px solid #10b981;
    }
    
    .check-icon::before {
      top: 2px;
      left: -1px;
      width: 19px;
      transform-origin: 100% 50%;
      border-radius: 100px 0 0 100px;
    }
    
    .check-icon::after {
      top: 0;
      left: 19px;
      width: 38px;
      transform-origin: 0 50%;
      border-radius: 0 100px 100px 0;
      animation: rotate-circle 4.25s ease-in;
    }
    
    .check-icon::before, .check-icon::after {
      content: '';
      height: 62px;
      position: absolute;
      background: #f9fafb;
      transform: rotate(-45deg);
    }
    
    .icon-line {
      height: 3px;
      background-color: #10b981;
      display: block;
      border-radius: 2px;
      position: absolute;
      z-index: 10;
    }
    
    .icon-line.line-tip {
      top: 29px;
      left: 9px;
      width: 16px;
      transform: rotate(45deg);
      animation: icon-line-tip 0.75s;
    }
    
    .icon-line.line-long {
      top: 24px;
      right: 5px;
      width: 29px;
      transform: rotate(-45deg);
      animation: icon-line-long 0.75s;
    }
    
    .icon-circle {
      top: -3px;
      left: -3px;
      z-index: 10;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      position: absolute;
      box-sizing: content-box;
      border: 3px solid rgba(16, 185, 129, 0.5);
    }
    
    .icon-fix {
      top: 5px;
      width: 3px;
      left: 16px;
      z-index: 1;
      height: 53px;
      position: absolute;
      transform: rotate(-45deg);
      background-color: #f9fafb;
    }
    
    @keyframes rotate-circle {
      0% {
        transform: rotate(-45deg);
      }
      5% {
        transform: rotate(-45deg);
      }
      12% {
        transform: rotate(-405deg);
      }
      100% {
        transform: rotate(-405deg);
      }
    }
    
    @keyframes icon-line-tip {
      0% {
        width: 0;
        left: 1px;
        top: 12px;
      }
      54% {
        width: 0;
        left: 1px;
        top: 12px;
      }
      70% {
        width: 31px;
        left: -5px;
        top: 23px;
      }
      84% {
        width: 11px;
        left: 13px;
        top: 30px;
      }
      100% {
        width: 16px;
        left: 9px;
        top: 28px;
      }
    }
    
    @keyframes icon-line-long {
      0% {
        width: 0;
        right: 29px;
        top: 34px;
      }
      65% {
        width: 0;
        right: 29px;
        top: 34px;
      }
      84% {
        width: 34px;
        right: 0px;
        top: 22px;
      }
      100% {
        width: 29px;
        right: 5px;
        top: 24px;
      }
    }
    
    /* Error X Animation */
    .error-checkmark {
      width: 50px;
      height: 50px;
      margin: 0 auto 0.5rem;
    }
    
    .error-icon {
      width: 50px;
      height: 50px;
      position: relative;
      border-radius: 50%;
      box-sizing: content-box;
      border: 3px solid #ef4444;
      background-color: #f9fafb;
    }
    
    .error-icon::before,
    .error-icon::after {
      content: '';
      position: absolute;
      height: 3px;
      width: 29px;
      background-color: #ef4444;
      border-radius: 2px;
      top: 23px;
      left: 10px;
    }
    
    .error-icon::before {
      transform: rotate(45deg);
      animation: error-icon-line 0.75s;
    }
    
    .error-icon::after {
      transform: rotate(-45deg);
      animation: error-icon-line 0.75s 0.25s;
    }
    
    .error-circle {
      top: -3px;
      left: -3px;
      z-index: 10;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      position: absolute;
      box-sizing: content-box;
      border: 3px solid rgba(239, 68, 68, 0.5);
      animation: pulse-error 1.5s ease-in-out infinite;
    }
    
    @keyframes error-icon-line {
      0% {
        width: 0;
      }
      100% {
        width: 29px;
      }
    }
    
    @keyframes pulse-error {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(1.05);
      }
    }
    
    .pulse {
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(1.05);
      }
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
      
      .header .username {
        font-size: 1rem;
      }
      
      .logout-btn {
        position: static;
        display: block;
        margin: 0 auto 1.5rem;
        width: fit-content;
        padding: 0.625rem 1.25rem;
        font-size: 0.85rem;
      }
      
      .card {
        padding: 1.5rem;
        border-radius: 16px;
      }
      
      .scanner-title {
        font-size: 1.25rem;
        margin-bottom: 1.25rem;
      }
      
      .video-container {
        max-width: 90%;
        border-width: 3px;
        margin-bottom: 1.5rem;
      }
      
      .scanner-frame {
        width: 96%;
        height: 96%;
      }
      
      .scanner-frame::before,
      .scanner-frame::after,
      .corner-tl,
      .corner-tr {
        width: 50px;
        height: 50px;
        border-width: 5px;
      }
      
      .scanner-frame::before {
        top: -5px;
        left: -5px;
      }
      
      .scanner-frame::after {
        bottom: -5px;
        right: -5px;
      }
      
      .corner-tl {
        top: -5px;
        right: -5px;
      }
      
      .corner-tr {
        bottom: -5px;
        left: -5px;
      }
      
      .result-container {
        min-height: 70px;
        padding: 1.25rem;
      }
      
      .result-text {
        font-size: 1rem;
      }
      
      .success-checkmark,
      .error-checkmark {
        width: 40px;
        height: 40px;
      }
      
      .check-icon,
      .error-icon {
        width: 40px;
        height: 40px;
      }
      
      .icon-circle,
      .error-circle {
        width: 40px;
        height: 40px;
      }
      
      .icon-line.line-tip {
        top: 23px;
        left: 7px;
        width: 13px;
      }
      
      .icon-line.line-long {
        top: 19px;
        right: 4px;
        width: 23px;
      }
      
      .error-icon::before,
      .error-icon::after {
        width: 23px;
        top: 18px;
        left: 8px;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 0.75rem;
      }
      
      .header {
        margin-bottom: 1.5rem;
      }
      
      .header h1 {
        font-size: 1.35rem;
      }
      
      .header .username {
        font-size: 0.95rem;
      }
      
      .card {
        padding: 1.25rem;
      }
      
      .scanner-title {
        font-size: 1.15rem;
      }
      
      .video-container {
        max-width: 95%;
      }
      
      .result-text {
        padding-top: 1rem;
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    {% if request.META.HTTP_REFERER and 'admin-dashboard' in request.META.HTTP_REFERER %}
    <a href="{% url 'admin_dashboard' %}" class="logout-btn">‚Üê Back to Dashboard</a>
    {% else %}
    <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
    {% endif %}
    
    <div class="header">
      <h1>Scanner Portal</h1>
      <div class="infothing"> 
        <div class="username">{{ request.user.displayname }}</div>
        <div class="user-group">{% if user.graup == None %} Groupless {% else %} {{ user.graup.name }} {% endif %}</div>
      </div>
    </div>
    
    <div class="card">
      <h2 class="scanner-title">QR Code Scanner</h2>
      
      <div class="video-container">
        <video id="video" autoplay playsinline muted></video>
        <div class="scanner-overlay">
          <div class="scanner-frame">
            <div class="scan-line"></div>
            <div class="corner-tl"></div>
            <div class="corner-tr"></div>
          </div>
        </div>
      </div>
      
      <canvas id="canvas"></canvas>
      
      <div id="result" class="result-container">
        <div class="result-text result-ready pulse">üì∑ Ready to scan</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const result = document.getElementById('result');
    let scanning = true;
    
    // Timer Variables
    let autoResetTimer = null;
    let countdownInterval = null;
    const RESET_TIME = 20; // Seconds until auto-reset

    setTimeout(() => result.classList.add('show'), 100);
    
    async function startCamera() {
      console.log('Attempting to start camera...');
      
      const isLocalhost = window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1' ||
                          window.location.hostname === '[::1]' ||
                          window.location.hostname.endsWith('.local');
      
      const isHTTP = window.location.protocol === 'http:';
      
      if (!navigator.mediaDevices) {
        if (isHTTP && !isLocalhost) {
          result.innerHTML = '<div class="error-checkmark"><div class="error-icon"><span class="error-circle"></span></div></div><div class="result-text result-error">Camera requires HTTPS.</div>';
        } else {
          result.innerHTML = '<div class="error-checkmark"><div class="error-icon"><span class="error-circle"></span></div></div><div class="result-text result-error">Camera not supported.</div>';
        }
        return;
      }
      
      try {
        let stream = null;
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        const constraints = isMobile ? [
          { video: { facingMode: { exact: 'environment' } }, audio: false },
          { video: { facingMode: 'environment' }, audio: false },
          { video: true, audio: false }
        ] : [
          { video: { width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false },
          { video: true, audio: false }
        ];
        
        for (let i = 0; i < constraints.length; i++) {
          try {
            stream = await navigator.mediaDevices.getUserMedia(constraints[i]);
            break;
          } catch (err) {}
        }
        
        if (!stream) throw new Error('Failed to obtain camera stream');
        
        video.srcObject = stream;
        video.setAttribute('autoplay', '');
        video.setAttribute('playsinline', '');
        video.setAttribute('muted', '');
        
        try {
          await video.play();
        } catch (playErr) {
          video.play().catch(e => console.error(e));
        }
        
        requestAnimationFrame(tick);
        
      } catch (e) {
        let errorMessage = 'Camera access failed';
        if (e.name === 'NotAllowedError') errorMessage = 'Permission denied.';
        else if (e.name === 'NotFoundError') errorMessage = 'No camera found.';
        
        result.innerHTML = `<div class="error-checkmark"><div class="error-icon"><span class="error-circle"></span></div></div><div class="result-text result-error">${errorMessage}</div>`;
      }
    }
    
    startCamera();
    
    function tick() {
      if (!scanning) return;
      
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        if (canvas.width > 0 && canvas.height > 0) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          
          try {
            const code = jsQR(imgData.data, imgData.width, imgData.height, {
              inversionAttempts: "dontInvert",
            });
            
            if (code) {
              console.log('QR Code detected:', code.data);
              scanning = false;
              result.innerHTML = '<div class="result-text result-scanning">üì° Sending to server...</div>';
              sendToken(code.data);
              return;
            }
          } catch (err) {
            console.error('jsQR error:', err);
          }
        }
      }
      
      requestAnimationFrame(tick);
    }
    
    // Function to manually reset the scanner when button is clicked
    function manualReset() {
        // Clear any pending timers
        if (autoResetTimer) clearTimeout(autoResetTimer);
        if (countdownInterval) clearInterval(countdownInterval);
        
        // Reset UI
        scanning = true;
        result.innerHTML = '<div class="result-text result-ready pulse">üì∑ Ready to scan</div>';
        requestAnimationFrame(tick);
    }

    async function sendToken(token) {
      try {
        const resp = await fetch("{% url 'scan_endpoint' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify({ token })
        });
        const data = await resp.json();
        
        let resultHTML = '';
        
        if (data.ok) {
          resultHTML = `
            <div class="success-checkmark">
              <div class="check-icon">
                <span class="icon-line line-tip"></span>
                <span class="icon-line line-long"></span>
                <div class="icon-circle"></div>
                <div class="icon-fix"></div>
              </div>
            </div>
            <div class="result-text result-success">
                Member : ${data.username} <br> 
                Event : ${data.eventname} <br> 
                Group : ${data.group} <br> 
                Time : ${data.checked_at} <br> 
                Checked in successfully!
            </div>
          `;
        } else {
          resultHTML = `
            <div class="error-checkmark">
              <div class="error-icon">
                <span class="error-circle"></span>
              </div>
            </div>
            <div class="result-text result-error">${data.error || 'Scan error'}</div>
          `;
        }

        // ADD THE BUTTON AND INJECT INTO HTML
        resultHTML += `
            <button id="scanNextBtn" class="scan-next-btn" onclick="manualReset()">
                Scan Next (${RESET_TIME}s)
            </button>
        `;
        
        result.innerHTML = resultHTML;

        // --- START TIMER LOGIC ---
        let timeLeft = RESET_TIME;
        const btnElement = document.getElementById('scanNextBtn');

        // Update button text every second
        countdownInterval = setInterval(() => {
            timeLeft--;
            if(btnElement) {
                btnElement.innerText = `Scan Next (${timeLeft}s)`;
            }
            if(timeLeft <= 0) {
                clearInterval(countdownInterval);
            }
        }, 1000);

        // Auto reset after RESET_TIME seconds
        autoResetTimer = setTimeout(() => {
            manualReset();
        }, RESET_TIME * 1000);
        // --- END TIMER LOGIC ---

      } catch (e) {
        console.error('Network error:', e);
        // In case of network error, show error and auto-retry faster (e.g., 5s)
        result.innerHTML = `
          <div class="error-checkmark">
            <div class="error-icon">
              <span class="error-circle"></span>
            </div>
          </div>
          <div class="result-text result-error">Network error: ${e.message}</div>
          <button class="scan-next-btn" onclick="manualReset()">Try Again</button>
        `;
      }
    }
    
    function getCookie(name) {
      const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }
  </script>
</body>
</html>